import React, { useState, useEffect } from "react"
import { Edit2Icon, CheckIcon, XIcon, RefreshCw } from "lucide-react"
import DatePicker from "react-datepicker"
import "react-datepicker/dist/react-datepicker.css"
import { API, NetworkManager } from "network/core"
import { PageLoader } from "components"
import moment from "moment"
import debounce from "lodash.debounce"
import { MenuItem, Select } from "@mui/material"
import DownloadPDFButton from "./OrdereRecipt"
import DispatchForm from "./DispatchedForm"
import DispatchList from "./DispatchedList"
import { Toast } from "helpers/toasts/toastHelper"
import FarmReadyButton from "./FarmReadyButton"
import { faHourglassEmpty } from "@fortawesome/free-solid-svg-icons"
import { FaUser, FaCreditCard, FaEdit, FaFileAlt } from "react-icons/fa"
import ConfirmDialog from "components/Modals/ConfirmDialog"
import {
  useHasPaymentAddAccess,
  useIsOfficeAdmin,
  useIsDealer,
  useDealerWallet,
  useDealerWalletById
} from "utils/roleUtils"

const FarmerOrdersTable = ({ slotId, monthName, startDay, endDay }) => {
  const today = new Date()
  const [searchTerm, setSearchTerm] = useState("")
  const [expandedRows, setExpandedRows] = useState(new Set())
  const [editingRows, setEditingRows] = useState(new Set())
  const [selectedDateRange, setSelectedDateRange] = useState([
    new Date(today.getFullYear(), 0, 1),
    today
  ])
  const [loading, setLoading] = useState(false)
  const [orders, setOrders] = useState([])
  const [patchLoading, setpatchLoading] = useState(false)
  const [startDate, endDate] = selectedDateRange
  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState("")
  const [refresh, setRefresh] = useState(false)
  const [selectedRow, setSelectedRow] = useState(null)

  // Role-based access control
  const hasPaymentAddAccess = useHasPaymentAddAccess()
  const isOfficeAdmin = useIsOfficeAdmin()
  const isDealer = useIsDealer()
  const { walletData, loading: walletLoading } = useDealerWallet()

  // State to track dealer ID for wallet data
  const [dealerIdForWallet, setDealerIdForWallet] = useState(null)

  // Dealer wallet data for when sales person is a dealer
  const { walletData: dealerWalletData, loading: dealerWalletLoading } =
    useDealerWalletById(dealerIdForWallet)

  // Status tabs state
  const [activeStatusTab, setActiveStatusTab] = useState("all")

  // Filter states
  const [selectedSalesPerson, setSelectedSalesPerson] = useState("")
  const [selectedVillage, setSelectedVillage] = useState("")
  const [selectedDistrict, setSelectedDistrict] = useState("")

  // Filter options
  const [salesPeople, setSalesPeople] = useState([])
  const [villages, setVillages] = useState([])
  const [districts, setDistricts] = useState([])

  const orderStatusOptions = [
    { label: "Accepted", value: "ACCEPTED" },
    { label: "Pending", value: "PENDING" },
    { label: "Rejected", value: "REJECTED" },
    { label: "Dispatched", value: "DISPATCHED" },
    { label: "Completed", value: "COMPLETED" },
    { label: "Partially Completed", value: "PARTIALLY_COMPLETED" },
    { label: "Ready For Dispatch", value: "FARM_READY" },
    { label: "Loading", value: "DISPATCH_PROCESS" }
  ]

  // Status tabs configuration
  const statusTabs = [
    { key: "all", label: "All Orders", status: null },
    { key: "pending", label: "Pending", status: "PENDING" },
    { key: "accepted", label: "Accepted", status: "ACCEPTED" },
    { key: "completed", label: "Completed", status: "COMPLETED" },
    { key: "dispatched", label: "Dispatched", status: "DISPATCHED" },
    { key: "farm_ready", label: "Farm Ready", status: "FARM_READY" },
    { key: "rejected", label: "Rejected", status: "REJECTED" }
  ]

  const [slots, setSlots] = useState([])
  const [updatedObject, setUpdatedObject] = useState(null)
  const [viewMode, setViewMode] = useState("booking")
  const [selectedRows, setSelectedRows] = useState(new Set())
  const [isDispatchFormOpen, setIsDispatchFormOpen] = useState(false)
  const [isDispatchtab, setisDispatchtab] = useState(false)
  const [newRemark, setNewRemark] = useState("")
  const [showPaymentForm, setShowPaymentForm] = useState(false)
  const [newPayment, setNewPayment] = useState({
    paidAmount: "",
    paymentDate: moment().format("YYYY-MM-DD"),
    modeOfPayment: "",
    bankName: "",
    remark: "",
    receiptPhoto: [],
    paymentStatus: isOfficeAdmin ? "PENDING" : "COLLECTED",
    isWalletPayment: false
  })
  const [isOrderModalOpen, setIsOrderModalOpen] = useState(false)
  const [selectedOrder, setSelectedOrder] = useState(null)
  const [activeTab, setActiveTab] = useState("overview")
  const [confirmDialog, setConfirmDialog] = useState({
    open: false,
    title: "",
    description: "",
    onConfirm: null
  })
  const handleFarmReady = (orderId) => {
    // Get current date
    const farmReadyDate = moment().format("DD-MM-YYYY")

    // Call pacthOrders with FARM_READY status
    pacthOrders(
      {
        id: orderId,
        orderStatus: "FARM_READY",
        farmReadyDate: farmReadyDate
      },
      null // No row data needed for this simple update
    )
  }
  // Add these handler functions
  const handleAddRemark = (orderId) => {
    if (!newRemark.trim()) return

    pacthOrders(
      {
        id: orderId,
        orderRemarks: newRemark
      },
      selectedRow
    ).then(async () => {
      // Refresh both modal data and main list
      await getOrders()
      setTimeout(() => {
        refreshModalData()
      }, 500)
    })

    setNewRemark("")
  }

  const handleAddPayment = async (orderId) => {
    if (!newPayment.paidAmount || !newPayment.modeOfPayment) {
      Toast.error("Please fill in amount and payment mode")
      return
    }

    // Validate wallet payment for dealers
    if (isDealer && newPayment.isWalletPayment) {
      const availableAmount = walletData?.financial?.availableAmount || 0
      const paymentAmount = Number(newPayment.paidAmount)

      if (paymentAmount > availableAmount) {
        Toast.error(`Insufficient wallet balance. Available: ₹${availableAmount.toLocaleString()}`)
        return
      }
    }

    // Validate dealer wallet payment for accountants (when sales person is dealer)
    if (
      !isDealer &&
      selectedOrder?.details?.salesPerson?.jobTitle === "DEALER" &&
      newPayment.isWalletPayment
    ) {
      const availableAmount = dealerWalletData?.financial?.availableAmount || 0
      const paymentAmount = Number(newPayment.paidAmount)

      if (paymentAmount > availableAmount) {
        Toast.error(
          `Insufficient dealer wallet balance. Available: ₹${availableAmount.toLocaleString()}`
        )
        return
      }
    }

    setLoading(true)
    try {
      const instance = NetworkManager(API.ORDER.ADD_PAYMENT)

      // Set payment status based on user role
      let paymentStatus = newPayment.paymentStatus || "COLLECTED"
      if (isOfficeAdmin) {
        paymentStatus = "PENDING"
      }

      const payload = {
        ...newPayment,
        paymentStatus: paymentStatus
      }
      const response = await instance.request(payload, [orderId])

      if (response?.data) {
        Toast.success(response?.data?.message || "Payment added successfully")
        setShowPaymentForm(false)
        setNewPayment({
          paidAmount: "",
          paymentDate: moment().format("YYYY-MM-DD"),
          modeOfPayment: "",
          bankName: "",
          remark: "",
          receiptPhoto: [],
          paymentStatus: isOfficeAdmin ? "PENDING" : "COLLECTED",
          isWalletPayment: false
        })
        // Refresh both modal data and main list
        await getOrders()
        setTimeout(() => {
          refreshModalData()
        }, 500)
      } else {
        Toast.error("Failed to add payment")
      }
    } catch (error) {
      console.error("Error adding payment:", error)
      Toast.error("Failed to add payment")
    } finally {
      setLoading(false)
    }
  }

  const handlePaymentInputChange = (field, value) => {
    setNewPayment((prev) => ({
      ...prev,
      [field]: value
    }))
  }

  const refreshModalData = async () => {
    if (selectedOrder) {
      // Refresh the orders to get updated data
      await getOrders()
      // Find the updated order data
      const updatedOrder = orders.find(
        (order) => order.details.orderid === selectedOrder.details.orderid
      )
      if (updatedOrder) {
        setSelectedOrder(updatedOrder)
      }
    }
  }

  // Add function to handle row selection
  const toggleRowSelection = (orderId, rowData) => {
    setSelectedRows((prevSelectedRows) => {
      const newSelectedRows = new Map(prevSelectedRows)

      // If row is already selected, remove it
      if (newSelectedRows.has(orderId)) {
        newSelectedRows.delete(orderId)
      } else {
        // Add the full row data to the map
        newSelectedRows.set(orderId, {
          ...rowData,
          details: {
            ...rowData.details,
            orderid: orderId
          }
        })
      }

      return newSelectedRows
    })
  }
  // Add function to handle "Select All" functionality
  const toggleSelectAll = () => {
    if (selectedRows.size === orders.length) {
      setSelectedRows(new Set())
    } else {
      const allOrderIds = orders.map((order) => order.details.orderid)
      setSelectedRows(new Set(allOrderIds))
    }
  }
  // Load initial data
  useEffect(() => {
    if (startDate && endDate) {
      getOrders()
    }
  }, [
    debouncedSearchTerm,
    refresh,
    startDate,
    endDate,
    viewMode,
    activeStatusTab,
    selectedSalesPerson,
    selectedVillage,
    selectedDistrict
  ])

  // Update dealer ID for wallet when selectedOrder changes
  useEffect(() => {
    if (selectedOrder?.details?.salesPerson?.jobTitle === "DEALER") {
      setDealerIdForWallet(selectedOrder?.details?.salesPerson?._id)
    } else {
      setDealerIdForWallet(null)
    }
  }, [selectedOrder])

  // Load filter options on component mount
  useEffect(() => {
    loadFilterOptions()
  }, [])

  // Listen for dispatch creation events to refresh the list
  useEffect(() => {
    const handleDispatchCreated = () => {
      getOrders()
    }

    window.addEventListener("dispatchCreated", handleDispatchCreated)

    return () => {
      window.removeEventListener("dispatchCreated", handleDispatchCreated)
    }
  }, [])

  useEffect(() => {
    if (selectedRow?.details?.plantID && selectedRow?.details?.plantSubtypeID) {
      getSlots(selectedRow?.details?.plantID, selectedRow?.details?.plantSubtypeID)
    }
  }, [selectedRow])

  const loadFilterOptions = async () => {
    try {
      // Load all salespeople and dealers in a single list
      const salesInstance = NetworkManager(API.USER.GET_USERS)
      const salesResponse = await salesInstance.request(null, { jobTitle: "SALES" })

      const dealersInstance = NetworkManager(API.USER.GET_DEALERS)
      const dealersResponse = await dealersInstance.request()

      // Combine salespeople and dealers
      const combinedData = []

      // Add salespeople
      if (salesResponse?.data?.data) {
        salesResponse.data.data.forEach((salesperson) => {
          combinedData.push({
            label: salesperson.name,
            value: salesperson._id,
            isDealer: false
          })
        })
      }

      // Add dealers with (Dealer) label
      if (dealersResponse?.data?.data) {
        dealersResponse.data.data.forEach((dealer) => {
          combinedData.push({
            label: `${dealer.name} (Dealer)`,
            value: dealer._id,
            isDealer: true
          })
        })
      }

      // Sort by name
      combinedData.sort((a, b) => a.label.localeCompare(b.label))

      setSalesPeople(combinedData)

      // Load villages
      const villagesInstance = NetworkManager(API.ORDER.GET_VILLAGES)
      const villagesResponse = await villagesInstance.request()
      if (villagesResponse?.data?.data) {
        setVillages(villagesResponse.data.data)
      }

      // Load districts
      const districtsInstance = NetworkManager(API.ORDER.GET_DISTRICTS)
      const districtsResponse = await districtsInstance.request()
      if (districtsResponse?.data?.data) {
        setDistricts(districtsResponse.data.data)
      }
    } catch (error) {
      console.error("Error loading filter options:", error)
    }
  }
  const debouncedSearch = React.useCallback(
    debounce((searchValue) => {
      setDebouncedSearchTerm(searchValue)
    }, 500), // 500ms delay
    [] // Empty dependency array to ensure the debounced function doesn't change
  )
  const handleSearchChange = (val) => {
    setSearchTerm(val)
    debouncedSearch(val)
  }
  const getTotalPaidAmount = (payments) => {
    return payments.reduce(
      (total, payment) => total + (payment?.paymentStatus == "COLLECTED" ? payment.paidAmount : 0),
      0
    )
  }
  React.useEffect(() => {
    // Cleanup the debounced function when component unmounts
    return () => {
      debouncedSearch.cancel()
    }
  }, [debouncedSearch])

  const getSlots = async (plantId, subtypeId) => {
    // Handle form submission
    try {
      //setLoading(true)

      const instance = NetworkManager(API.ORDER.GET_SLOTS)
      const emps = await instance.request(
        {},
        { plantId: plantId, subtypeId: subtypeId, year: new Date().getFullYear().toString() }
      )
      let apiSlots = emps?.data?.slots[0].slots
      if (emps.data) {
        const data = apiSlots?.filter((slot) => slot?.status)
        setSlots(
          data
            ?.map((district) => {
              const { startDay, endDay, totalBookedPlants, totalPlants, status, _id } =
                district || {}
              const start = moment(startDay, "DD-MM-YYYY").format("D")
              const end = moment(endDay, "DD-MM-YYYY").format("D")
              const monthYear = moment(startDay, "DD-MM-YYYY").format("MMMM, YYYY")
              if (!status) {
                return
              }
              return {
                label: `${start} - ${end} ${monthYear} (${totalPlants})`,
                value: _id,
                available: totalPlants - totalBookedPlants
              }
            })
            .filter((data) => data?.available)
        )
      }
    } catch (error) {
      // console.log(error)
      // Alert.alert("Error", errorMessage)
    } finally {
      //setLoading(false)
    }
  }

  const getOrders = async () => {
    setLoading(true)
    const date = new Date(startDate)
    const formattedStartDate = moment(date).format("DD-MM-YYYY")
    const edate = new Date(endDate)
    const formattedEndtDate = moment(edate).format("DD-MM-YYYY")

    // Use the new status-specific endpoint if a status tab is selected
    const instance =
      activeStatusTab !== "all"
        ? NetworkManager(API.ORDER.GET_ORDERS_BY_STATUS)
        : slotId
        ? NetworkManager(API.ORDER.GET_ORDERS_SLOTS)
        : NetworkManager(API.ORDER.GET_ORDERS)

    const params = {
      search: debouncedSearchTerm,
      startDate: formattedStartDate,
      endDate: formattedEndtDate,
      dispatched: viewMode === "booking" ? false : true,
      limit: 10000, // Set a very high limit to get all orders
      page: 1
    }

    // Add status filter if a specific status tab is selected
    if (activeStatusTab !== "all") {
      const selectedTab = statusTabs.find((tab) => tab.key === activeStatusTab)
      if (selectedTab && selectedTab.status) {
        params.status = selectedTab.status
      }
    }

    // Add new filter parameters
    if (selectedSalesPerson) {
      params.salesPerson = selectedSalesPerson
    }
    if (selectedVillage) {
      params.village = selectedVillage
    }
    if (selectedDistrict) {
      params.district = selectedDistrict
    }

    if (viewMode === "dispatched") {
      params.status = "ACCEPTED,FARM_READY"
    }

    if (viewMode === "farmready") {
      params.status = "FARM_READY"
    }
    if (viewMode === "farmready" || viewMode === "dispatch_process") {
      params.startDate = null
    }

    if (viewMode === "farmready" || viewMode === "dispatch_process") {
      params.endDate = null
    }
    if (viewMode === "farmready") {
      params.status = "FARM_READY"
    }
    if (viewMode === "dispatch_process") {
      params.status = "DISPATCH_PROCESS"
    }
    if (viewMode === "dispatch_process") {
      params.dispatched = false
    }
    console.log(params)

    const emps = slotId
      ? await instance.request({}, { slotId, monthName, startDay, endDay, limit: 10000, page: 1 })
      : await instance.request({}, params)

    setOrders(
      emps?.data?.data?.data?.map((data) => {
        const {
          farmer,
          //   typeOfPlants,
          numberOfPlants,
          rate,
          salesPerson,
          createdAt,
          orderStatus,
          id,
          payment,
          bookingSlot,
          orderId,
          plantType,
          plantSubtype,
          remainingPlants,
          returnedPlants,
          statusChanges,
          orderRemarks,
          dealerOrder,
          farmReadyDate,
          orderBookingDate
        } = data || {}
        const { startDay, endDay } = bookingSlot?.[0] || {}
        const start = moment(startDay, "DD-MM-YYYY").format("D")
        const end = moment(endDay, "DD-MM-YYYY").format("D")
        const monthYear = moment(startDay, "DD-MM-YYYY").format("MMMM, YYYY")
        return {
          order: orderId,
          farmerName: dealerOrder ? `via ${salesPerson?.name}` : farmer?.name,
          plantType: `${plantType?.name} -> ${plantSubtype?.name}`,
          quantity: numberOfPlants,
          orderDate: moment(orderBookingDate || createdAt).format("DD/MM/YYYY"),
          rate,
          total: `₹ ${Number(rate * numberOfPlants)}`,
          "Paid Amt": `₹ ${Number(getTotalPaidAmount(payment))}`,
          "remaining Amt": `₹ ${
            Number(rate * numberOfPlants) - Number(getTotalPaidAmount(payment))
          }`,
          "remaining Plants": remainingPlants || numberOfPlants,
          "returned Plants": returnedPlants || 0,
          orderStatus: orderStatus,
          Delivery: `${start} - ${end} ${monthYear}`,
          "Farm Ready":
            farmReadyDate && farmReadyDate.length > 0
              ? moment(farmReadyDate[0]).format("DD-MMM-YYYY")
              : "-",
          details: {
            farmer,
            contact: farmer?.mobileNumber,
            orderNotes: "Premium quality seed potatoes",
            soilType: "Sandy loam",
            irrigationType: "Sprinkler system",
            lastDelivery: "2024-11-05",
            payment,
            orderid: id,
            salesPerson,
            plantID: plantType?.id,
            plantSubtypeID: plantSubtype?.id,
            bookingSlot: bookingSlot[0],
            rate: rate,
            numberOfPlants,

            statusChanges: statusChanges || [],
            orderRemarks: orderRemarks || [],
            deliveryChanges: data.deliveryChanges || [],
            returnHistory: data?.returnHistory || [],
            dealerOrder: dealerOrder || faHourglassEmpty,
            farmReadyDate: farmReadyDate
          }
        }
      })
    )
    setLoading(false)

    // setEmployees(emps?.data?.data)
  }
  const pacthOrders = async (patchObj, row) => {
    setpatchLoading(true)

    try {
      // Handle Date objects for farmReadyDate
      const dataToSend = { ...patchObj }

      // If updating farmReadyDate specifically

      const instance = NetworkManager(API.ORDER.UPDATE_ORDER)
      const emps = await instance.request({
        ...dataToSend,
        numberOfPlants: dataToSend?.quantity
      })

      console.log(emps)
      refreshComponent()

      if (emps?.error) {
        Toast.error(emps?.error)
        setpatchLoading(false)
        return
      }

      if (emps?.data?.status === "Success") {
        // Your existing code for handling success
        if (dataToSend?.orderStatus === "ACCEPTED") {
          // Your existing WATI template code
        }
        setEditingRows(new Set())
        setUpdatedObject(null)
        // Refresh the main list immediately
        await getOrders()
        // Also refresh modal data if modal is open
        if (selectedOrder) {
          setTimeout(() => {
            refreshModalData()
          }, 500)
        }
      }
    } catch (error) {
      console.error("Error updating order:", error)
      Toast.error("Failed to update order")
    } finally {
      setpatchLoading(false)
    }
  }
  const saveEditedRow = (index, row) => {
    pacthOrders(
      {
        id: row?.details?.orderid,
        ...updatedObject
      },
      row
    )
  }

  const getStatusColor = (status) => {
    switch (status) {
      case "ACCEPTED":
        return "bg-green-100 text-green-700"
      case "PENDING":
        return "bg-yellow-100 text-yellow-700"
      case "REJECTED":
      case "CANCELLED":
        return "bg-red-100 text-red-700"
      case "DISPATCHED":
      case "PROCESSING":
        return "bg-blue-100 text-blue-700"
      case "COMPLETED":
        return "bg-gray-100 text-gray-700"
      case "PARTIALLY_COMPLETED":
        return "bg-indigo-100 text-indigo-700"
      case "FARM_READY":
        return "bg-amber-100 text-amber-700"
      case "DISPATCH_PROCESS":
        return "bg-cyan-100 text-cyan-700"
      default:
        return "bg-gray-50 text-gray-600"
    }
  }
  console.log(updatedObject)
  const toggleEditing = (index, row) => {
    // console.log(row)
    setSelectedRow(row)
    setUpdatedObject({
      rate: row?.rate,
      quantity: row?.quantity,
      bookingSlot: row?.details?.bookingSlot?.slotId
    })
    // setSelectedRow(row)
    const newEditingRows = new Set(editingRows)
    if (newEditingRows.has(index)) {
      newEditingRows.delete(index)
    } else {
      newEditingRows.add(index)
    }
    setEditingRows(newEditingRows)
  }
  const handleInputChange = (index, key, value) => {
    //const newData = [...orders]
    // newData[index][key] = value
    //  setData(newData)
    setUpdatedObject({ ...updatedObject, [key]: value })
  }

  const refreshComponent = () => {
    setRefresh(!refresh)
  }
  const cancelEditing = (index) => {
    const newEditingRows = new Set(editingRows)
    newEditingRows.delete(index)
    setEditingRows(newEditingRows)
    setUpdatedObject(null)
    setSelectedRow(null)
  }

  // Status change handler with confirmation
  const handleStatusChange = (row, newStatus) => {
    setConfirmDialog({
      open: true,
      title: "Confirm Status Change",
      description: `Change status of Order #${row.order} from ${row.orderStatus} to ${newStatus}?`,
      onConfirm: () => {
        setConfirmDialog((d) => ({ ...d, open: false }))
        pacthOrders(
          {
            id: row?.details?.orderid,
            orderStatus: newStatus
          },
          row
        )
      }
    })
  }

  // Payment add handler with confirmation
  const handleAddPaymentWithConfirm = (orderId) => {
    setConfirmDialog({
      open: true,
      title: "Confirm Add Payment",
      description: `Add payment of ₹${newPayment.paidAmount} (${
        newPayment.modeOfPayment
      }) to Order #${selectedOrder?.order || orderId}?`,
      onConfirm: async () => {
        setConfirmDialog((d) => ({ ...d, open: false }))
        await handleAddPayment(orderId)
      }
    })
  }

  // Handle status tab change
  const handleStatusTabChange = (tabKey) => {
    setActiveStatusTab(tabKey)
  }

  // Get filtered orders count for each tab
  const getOrdersCountByStatus = (status) => {
    if (!orders || orders.length === 0) return 0
    if (status === null) return orders.length
    return orders.filter((order) => order.orderStatus === status).length
  }

  return (
    <div className="w-full p-4 bg-gray-50">
      {(loading || patchLoading) && <PageLoader />}

      {/* Header Controls */}
      <div className="mb-6 space-y-4">
        {/* Date range picker and search box */}
        <div className="flex flex-col lg:flex-row gap-4">
          {!slotId && (
            <div className="flex-1">
              <DatePicker
                selectsRange={true}
                startDate={startDate}
                endDate={endDate}
                onChange={(update) => setSelectedDateRange(update)}
                isClearable={true}
                placeholderText="Select date range"
                className="w-full p-3 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                calendarClassName="custom-datepicker"
              />
            </div>
          )}
          <div className="flex-1">
            <input
              type="text"
              placeholder="Search orders..."
              value={searchTerm}
              onChange={(e) => handleSearchChange(e.target.value)}
              className="w-full p-3 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        {/* Filter Dropdowns */}
        <div className="bg-white rounded-lg shadow-sm border p-4">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {/* Sales Person/Dealer Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Sales Person / Dealer
              </label>
              <Select
                value={selectedSalesPerson}
                onChange={(e) => setSelectedSalesPerson(e.target.value)}
                displayEmpty
                className="w-full"
                size="small">
                <MenuItem value="">
                  <em>All Sales People & Dealers</em>
                </MenuItem>
                {salesPeople.map((person) => (
                  <MenuItem key={person.value} value={person.value}>
                    {person.label}
                  </MenuItem>
                ))}
              </Select>
            </div>

            {/* Village Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Village</label>
              <Select
                value={selectedVillage}
                onChange={(e) => setSelectedVillage(e.target.value)}
                displayEmpty
                className="w-full"
                size="small">
                <MenuItem value="">
                  <em>All Villages</em>
                </MenuItem>
                {villages.map((village) => (
                  <MenuItem key={village} value={village}>
                    {village}
                  </MenuItem>
                ))}
              </Select>
            </div>

            {/* District Filter */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">District</label>
              <Select
                value={selectedDistrict}
                onChange={(e) => setSelectedDistrict(e.target.value)}
                displayEmpty
                className="w-full"
                size="small">
                <MenuItem value="">
                  <em>All Districts</em>
                </MenuItem>
                {districts.map((district) => (
                  <MenuItem key={district} value={district}>
                    {district}
                  </MenuItem>
                ))}
              </Select>
            </div>
          </div>

          {/* Clear Filters Button */}
          <div className="mt-4 flex justify-end">
            <button
              onClick={() => {
                setSelectedSalesPerson("")
                setSelectedVillage("")
                setSelectedDistrict("")
              }}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
              Clear Filters
            </button>
          </div>
        </div>

        {/* Status Tabs */}
        <div className="bg-white rounded-lg shadow-sm border p-2">
          <div className="flex flex-wrap gap-2">
            {statusTabs.map((tab) => (
              <button
                key={tab.key}
                onClick={() => handleStatusTabChange(tab.key)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
                  activeStatusTab === tab.key
                    ? "bg-blue-600 text-white shadow-md"
                    : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                }`}>
                {tab.label}
                <span className="ml-2 bg-white bg-opacity-20 px-2 py-1 rounded-full text-xs">
                  {getOrdersCountByStatus(tab.status)}
                </span>
              </button>
            ))}
          </div>
        </div>

        {/* View mode toggle buttons */}
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => setViewMode("booking")}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
              viewMode === "booking"
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
            }`}>
            Booking Orders
          </button>
          <button
            onClick={() => setViewMode("dispatched")}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
              viewMode === "dispatched"
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
            }`}>
            Dispatched Orders
          </button>
          <button
            onClick={() => setViewMode("farmready")}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
              viewMode === "farmready"
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
            }`}>
            Farm Ready
          </button>
          <button
            onClick={() => setViewMode("dispatch_process")}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
              viewMode === "dispatch_process"
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
            }`}>
            Loading
          </button>
        </div>
      </div>

      {/* Dispatch list component */}
      <DispatchList setisDispatchtab={setisDispatchtab} viewMode={viewMode} refresh={refresh} />

      {/* Orders Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
        {orders.map((row, index) => (
          <div
            key={index}
            className={`bg-white rounded-lg shadow-sm border hover:shadow-md transition-all duration-200 cursor-pointer ${
              row?.details?.payment.some((payment) => payment.paymentStatus === "PENDING")
                ? "animate-pulse border-amber-200"
                : ""
            } ${row?.details?.dealerOrder ? "border-sky-200 bg-sky-50" : ""}`}
            onClick={() => {
              setSelectedOrder(row)
              setIsOrderModalOpen(true)
            }}>
            {/* Card Header */}
            <div className="p-4 border-b border-gray-100">
              <div className="flex items-start justify-between mb-2">
                <div className="flex-1">
                  <h3 className="font-semibold text-gray-900 text-sm">Order #{row.order}</h3>
                  <p className="text-xs text-gray-500 mt-1">{row.farmerName}</p>
                </div>
                <div className="flex items-center space-x-2">
                  {viewMode === "farmready" && (
                    <input
                      type="checkbox"
                      onChange={(e) => {
                        e.stopPropagation()
                        toggleRowSelection(row.details.orderid, row)
                      }}
                      onClick={(e) => e.stopPropagation()}
                      checked={selectedRows.has(row.details.orderid)}
                      className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  )}
                  <DownloadPDFButton order={row} />
                </div>
              </div>

              {/* Status Badge */}
              <div className="flex items-center justify-between">
                <select
                  disabled={
                    row.orderStatus === "DISPATCH_PROCESS" || row.orderStatus === "COMPLETED"
                  }
                  value={row.orderStatus}
                  onChange={(e) => {
                    e.stopPropagation()
                    if (
                      e.target.value === "DISPATCH_PROCESS" ||
                      e.target.value === "DISPATCHED" ||
                      e.target.value === "COMPLETED"
                    ) {
                      Toast.info("This status cant be change directly")
                      return
                    }
                    handleStatusChange(row, e.target.value)
                  }}
                  onClick={(e) => e.stopPropagation()}
                  className={`${getStatusColor(
                    row.orderStatus
                  )} px-2 py-1 rounded-full text-xs font-medium focus:outline-none`}>
                  {orderStatusOptions.map((option) => (
                    <option key={option?.value} value={option?.value}>
                      {option?.label}
                    </option>
                  ))}
                </select>

                {row.orderStatus === "ACCEPTED" && (
                  <FarmReadyButton
                    orderId={row.details.orderid}
                    onUpdateOrder={pacthOrders}
                    refreshOrders={refreshComponent}
                  />
                )}
              </div>
            </div>

            {/* Card Body */}
            <div className="p-4 space-y-3">
              {/* Plant Info */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Plant Type</span>
                <span className="text-sm font-medium text-gray-900">{row.plantType}</span>
              </div>

              {/* Quantity & Rate */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <span className="text-xs text-gray-500">Quantity</span>
                  <div className="text-sm font-medium text-gray-900">{row.quantity}</div>
                </div>
                <div>
                  <span className="text-xs text-gray-500">Rate</span>
                  <div className="text-sm font-medium text-gray-900">₹{row.rate}</div>
                </div>
              </div>

              {/* Financial Info */}
              <div className="bg-gray-50 rounded-md p-3 space-y-2">
                <div className="flex justify-between">
                  <span className="text-xs text-gray-500">Total</span>
                  <span className="text-sm font-semibold text-gray-900">{row.total}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-xs text-gray-500">Paid</span>
                  <span className="text-sm text-green-600">{row["Paid Amt"]}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-xs text-gray-500">Remaining</span>
                  <span className="text-sm text-amber-600">{row["remaining Amt"]}</span>
                </div>
              </div>

              {/* Delivery Info */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Delivery</span>
                <span className="text-sm font-medium text-blue-600">{row.Delivery}</span>
              </div>

              {/* Farm Ready Date */}
              {row["Farm Ready"] !== "-" && (
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-500">Farm Ready</span>
                  <span className="text-sm font-medium text-amber-600">{row["Farm Ready"]}</span>
                </div>
              )}

              {/* Action Buttons */}
              {viewMode !== "dispatch_process" &&
                row?.orderStatus !== "COMPLETED" &&
                row?.orderStatus !== "DISPATCH_PROCESS" &&
                row?.orderStatus !== "DISPATCHED" && (
                  <div className="flex items-center justify-end space-x-2 pt-2 border-t border-gray-100">
                    {editingRows.has(index) ? (
                      <>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            saveEditedRow(index, row)
                          }}
                          className="text-green-500 hover:text-green-700">
                          <CheckIcon size={16} />
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            cancelEditing(index)
                          }}
                          className="text-red-500 hover:text-red-700">
                          <XIcon size={16} />
                        </button>
                      </>
                    ) : (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          toggleEditing(index, row)
                        }}
                        className="text-gray-500 hover:text-gray-700">
                        <Edit2Icon size={16} />
                      </button>
                    )}
                  </div>
                )}
            </div>
          </div>
        ))}
      </div>

      {/* Fixed bottom bar for batch actions */}
      {viewMode !== "booking" && selectedRows.size > 0 && (
        <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm py-4 border-t shadow-lg z-50">
          <div className="flex justify-between items-center max-w-7xl mx-auto px-4">
            <div className="flex items-center space-x-2">
              <span className="text-sm text-gray-600">
                {selectedRows.size} {selectedRows.size === 1 ? "order" : "orders"} selected
              </span>
            </div>
            <button
              onClick={() => setIsDispatchFormOpen(true)}
              className="bg-blue-600 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 transition-colors flex items-center space-x-2">
              <span>Proceed to Dispatch</span>
            </button>
          </div>
        </div>
      )}

      {/* Dispatch form modal */}
      {isDispatchFormOpen && (
        <DispatchForm
          open={isDispatchFormOpen}
          onClose={() => {
            setIsDispatchFormOpen(false)
            setSelectedRows(new Set())
            getOrders()
          }}
          selectedOrders={selectedRows}
          orders={orders}
        />
      )}

      {/* Order Details Modal */}
      {isOrderModalOpen && selectedOrder && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl w-full max-w-7xl max-h-[95vh] overflow-hidden shadow-2xl">
            {/* Modal Header */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold">Order #{selectedOrder.order}</h2>
                  <p className="text-blue-100 mt-1">
                    {selectedOrder.farmerName} • {selectedOrder.plantType}
                  </p>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={refreshModalData}
                    className="text-white hover:text-blue-100 transition-colors p-1 rounded hover:bg-white hover:bg-opacity-10">
                    <RefreshCw size={20} />
                  </button>
                  <button
                    onClick={() => {
                      setIsOrderModalOpen(false)
                      setSelectedOrder(null)
                      setShowPaymentForm(false)
                      setNewPayment({
                        paidAmount: "",
                        paymentDate: moment().format("YYYY-MM-DD"),
                        modeOfPayment: "",
                        bankName: "",
                        remark: "",
                        receiptPhoto: []
                      })
                    }}
                    className="text-white hover:text-blue-100 transition-colors">
                    <XIcon size={28} />
                  </button>
                </div>
              </div>
            </div>

            {/* Modal Content */}
            <div className="overflow-y-auto max-h-[calc(95vh-120px)]">
              <div className="p-6">
                {/* Order Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <div className="text-blue-600 text-sm font-medium">Total Value</div>
                    <div className="text-2xl font-bold text-blue-900">
                      ₹{selectedOrder.rate * selectedOrder.quantity}
                    </div>
                  </div>
                  <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                    <div className="text-green-600 text-sm font-medium">Paid Amount</div>
                    <div className="text-2xl font-bold text-green-900">
                      ₹{getTotalPaidAmount(selectedOrder?.details?.payment)}
                    </div>
                  </div>
                  <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                    <div className="text-amber-600 text-sm font-medium">Remaining</div>
                    <div className="text-2xl font-bold text-amber-900">
                      ₹
                      {selectedOrder.rate * selectedOrder.quantity -
                        getTotalPaidAmount(selectedOrder?.details?.payment)}
                    </div>
                  </div>
                  <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                    <div className="text-purple-600 text-sm font-medium">Status</div>
                    <div className="text-lg font-bold text-purple-900">
                      {selectedOrder.orderStatus}
                    </div>
                  </div>
                </div>

                {/* Main Content Tabs */}
                <div className="bg-white rounded-lg border">
                  {/* Tab Navigation */}
                  <div className="border-b border-gray-200">
                    <nav className="flex space-x-8 px-6" aria-label="Tabs">
                      <button
                        onClick={() => setActiveTab("overview")}
                        className={`inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                          activeTab === "overview"
                            ? "border-blue-500 text-blue-600"
                            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        }`}>
                        <FaUser size={16} className="mr-2" />
                        Overview
                      </button>
                      <button
                        onClick={() => setActiveTab("payments")}
                        className={`inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                          activeTab === "payments"
                            ? "border-blue-500 text-blue-600"
                            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        }`}>
                        <FaCreditCard size={16} className="mr-2" />
                        Payments
                      </button>
                      <button
                        onClick={() => setActiveTab("edit")}
                        className={`inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                          activeTab === "edit"
                            ? "border-blue-500 text-blue-600"
                            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        }`}>
                        <FaEdit size={16} className="mr-2" />
                        Edit Order
                      </button>
                      <button
                        onClick={() => setActiveTab("remarks")}
                        className={`inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                          activeTab === "remarks"
                            ? "border-blue-500 text-blue-600"
                            : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                        }`}>
                        <FaFileAlt size={16} className="mr-2" />
                        Remarks
                      </button>
                    </nav>
                  </div>

                  {/* Tab Content */}
                  <div className="p-6">
                    {activeTab === "overview" && (
                      <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="bg-gray-50 rounded-lg p-4">
                            <h3 className="font-medium text-gray-900 mb-3">Farmer Information</h3>
                            <div className="space-y-2">
                              <div>
                                <span className="text-sm text-gray-500">Name:</span>
                                <span className="ml-2 font-medium">
                                  {selectedOrder?.details?.farmer?.name}
                                </span>
                              </div>
                              <div>
                                <span className="text-sm text-gray-500">Village:</span>
                                <span className="ml-2 font-medium">
                                  {selectedOrder?.details?.farmer?.village}
                                </span>
                              </div>
                            </div>
                          </div>
                          <div className="bg-gray-50 rounded-lg p-4">
                            <h3 className="font-medium text-gray-900 mb-3">Sales Person</h3>
                            <div className="space-y-2">
                              <div>
                                <span className="text-sm text-gray-500">Name:</span>
                                <span className="ml-2 font-medium">
                                  {selectedOrder?.details?.salesPerson?.name}
                                </span>
                              </div>
                              <div>
                                <span className="text-sm text-gray-500">Contact:</span>
                                <span className="ml-2 font-medium">
                                  {selectedOrder?.details?.salesPerson?.phoneNumber}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="font-medium text-gray-900 mb-3">Order Details</h3>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                              <span className="text-sm text-gray-500">Plant Type:</span>
                              <div className="font-medium">{selectedOrder.plantType}</div>
                            </div>
                            <div>
                              <span className="text-sm text-gray-500">Quantity:</span>
                              <div className="font-medium">{selectedOrder.quantity}</div>
                            </div>
                            <div>
                              <span className="text-sm text-gray-500">Rate per Plant:</span>
                              <div className="font-medium">₹{selectedOrder.rate}</div>
                            </div>
                            <div>
                              <span className="text-sm text-gray-500">Delivery:</span>
                              <div className="font-medium">{selectedOrder.Delivery}</div>
                            </div>
                            <div>
                              <span className="text-sm text-gray-500">Order Date:</span>
                              <div className="font-medium">{selectedOrder.orderDate}</div>
                            </div>
                            <div>
                              <span className="text-sm text-gray-500">Farm Ready:</span>
                              <div className="font-medium">{selectedOrder["Farm Ready"]}</div>
                            </div>
                          </div>
                        </div>

                        {/* Farm Ready History */}
                        {selectedOrder?.details?.farmReadyDate &&
                          selectedOrder?.details?.farmReadyDate.length > 0 && (
                            <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                              <h3 className="font-medium text-amber-900 mb-3 flex items-center">
                                <span className="mr-2">🌾</span>
                                Farm Ready History
                              </h3>
                              <div className="space-y-2">
                                {selectedOrder.details.farmReadyDate.map((date, index) => (
                                  <div
                                    key={index}
                                    className={`flex items-center justify-between p-2 rounded ${
                                      index === 0 ? "bg-amber-100" : "bg-white"
                                    }`}>
                                    <span className="text-sm font-medium">
                                      {moment(date).format("DD MMMM, YYYY")}
                                    </span>
                                    {index === 0 && (
                                      <span className="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded-full">
                                        Latest
                                      </span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                        {/* Status History */}
                        {selectedOrder?.details?.statusChanges &&
                          selectedOrder?.details?.statusChanges.length > 0 && (
                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                              <h3 className="font-medium text-blue-900 mb-3 flex items-center">
                                <span className="mr-2">📊</span>
                                Status Change History
                              </h3>
                              <div className="space-y-2">
                                {selectedOrder.details.statusChanges.map((change, index) => (
                                  <div key={index} className="bg-white p-3 rounded border">
                                    <div className="flex items-center justify-between mb-1">
                                      <span className="text-sm font-medium text-gray-900">
                                        {change.fromStatus} → {change.toStatus}
                                      </span>
                                      <span className="text-xs text-gray-500">
                                        {moment(change.changedAt).format("DD/MM/YYYY HH:mm")}
                                      </span>
                                    </div>
                                    {change.changedBy && (
                                      <div className="text-xs text-gray-600">
                                        Changed by: {change.changedBy.name}
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                        {/* Delivery Changes */}
                        {selectedOrder?.details?.deliveryChanges &&
                          selectedOrder?.details?.deliveryChanges.length > 0 && (
                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                              <h3 className="font-medium text-green-900 mb-3 flex items-center">
                                <span className="mr-2">🚚</span>
                                Delivery Change History
                              </h3>
                              <div className="space-y-3">
                                {selectedOrder.details.deliveryChanges.map((change, index) => {
                                  const prevStartDay = change.previousDeliveryDate?.startDay
                                  const prevEndDay = change.previousDeliveryDate?.endDay
                                  const prevMonth = change.previousDeliveryDate?.month
                                  const prevYear = change.previousDeliveryDate?.year

                                  const newStartDay = change.newDeliveryDate?.startDay
                                  const newEndDay = change.newDeliveryDate?.endDay
                                  const newMonth = change.newDeliveryDate?.month
                                  const newYear = change.newDeliveryDate?.year

                                  return (
                                    <div key={index} className="bg-white p-3 rounded border">
                                      <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-900">
                                          Delivery Changed
                                        </span>
                                        <span className="text-xs text-gray-500">
                                          {moment(change.changedAt).format("DD/MM/YYYY")}
                                        </span>
                                      </div>
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                                        <div className="bg-red-50 px-3 py-2 rounded-md">
                                          <span className="text-red-500 line-through text-sm">
                                            {prevStartDay} - {prevEndDay} {prevMonth} {prevYear}
                                          </span>
                                        </div>
                                        <div className="flex justify-center">
                                          <span className="text-gray-400">→</span>
                                        </div>
                                        <div className="bg-green-50 px-3 py-2 rounded-md">
                                          <span className="text-green-600 font-medium text-sm">
                                            {newStartDay} - {newEndDay} {newMonth} {newYear}
                                          </span>
                                        </div>
                                      </div>
                                      {change.reasonForChange && (
                                        <div className="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded-md">
                                          <span className="font-medium">Reason:</span>{" "}
                                          {change.reasonForChange}
                                        </div>
                                      )}
                                    </div>
                                  )
                                })}
                              </div>
                            </div>
                          )}

                        {/* Return History */}
                        {selectedOrder?.details?.returnHistory &&
                          selectedOrder?.details?.returnHistory.length > 0 && (
                            <div className="bg-red-50 rounded-lg p-4 border border-red-200">
                              <h3 className="font-medium text-red-900 mb-3 flex items-center">
                                <span className="mr-2">🔄</span>
                                Plant Return History
                              </h3>
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div className="text-center">
                                  <div className="text-sm text-gray-500">Total Plants</div>
                                  <div className="text-xl font-bold text-gray-900">
                                    {selectedOrder.quantity}
                                  </div>
                                </div>
                                <div className="text-center">
                                  <div className="text-sm text-gray-500">Returned Plants</div>
                                  <div className="text-xl font-bold text-red-600">
                                    {selectedOrder["returned Plants"]}
                                  </div>
                                </div>
                                <div className="text-center">
                                  <div className="text-sm text-gray-500">Remaining Plants</div>
                                  <div className="text-xl font-bold text-green-600">
                                    {selectedOrder["remaining Plants"]}
                                  </div>
                                </div>
                              </div>
                              <div className="space-y-2">
                                {selectedOrder.details.returnHistory.map(
                                  (returnItem, returnIndex) => (
                                    <div key={returnIndex} className="bg-white p-3 rounded border">
                                      <div className="flex items-center justify-between mb-1">
                                        <span className="text-sm font-medium text-red-600">
                                          {returnItem.quantity} plants returned
                                        </span>
                                        <span className="text-xs text-gray-500">
                                          {returnItem.date
                                            ? moment(returnItem.date).format("DD/MM/YYYY")
                                            : "N/A"}
                                        </span>
                                      </div>
                                      {returnItem.reason && (
                                        <div className="text-sm text-gray-600">
                                          <span className="font-medium">Reason:</span>{" "}
                                          {returnItem.reason}
                                        </div>
                                      )}
                                      <div className="flex flex-wrap gap-2 mt-2">
                                        {returnItem.dispatchId && (
                                          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                            Dispatch ID: {returnItem.dispatchId}
                                          </span>
                                        )}
                                        {returnItem.processedBy && (
                                          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                            Processed by: {returnItem.processedBy.name}
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                  )
                                )}
                              </div>
                            </div>
                          )}
                      </div>
                    )}

                    {activeTab === "payments" && (
                      <div className="space-y-6">
                        <div className="flex items-center justify-between">
                          <h3 className="text-lg font-medium text-gray-900">Payment Management</h3>
                          {hasPaymentAddAccess && (
                            <button
                              onClick={() => setShowPaymentForm(!showPaymentForm)}
                              className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                              {showPaymentForm ? "Cancel" : "+ Add Payment"}
                              {isOfficeAdmin && (
                                <span className="ml-1 text-xs">(PENDING only)</span>
                              )}
                            </button>
                          )}
                        </div>

                        {showPaymentForm && (
                          <div className="bg-gray-50 rounded-lg p-6 border">
                            <h4 className="font-medium text-gray-900 mb-4">Add New Payment</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                              <div>
                                <label className="text-sm text-gray-500 font-medium">
                                  Amount (₹)
                                </label>
                                <input
                                  type="number"
                                  value={newPayment.paidAmount}
                                  onChange={(e) =>
                                    handlePaymentInputChange("paidAmount", e.target.value)
                                  }
                                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                                  placeholder="Enter amount"
                                />
                              </div>
                              <div>
                                <label className="text-sm text-gray-500 font-medium">
                                  Payment Date
                                </label>
                                <input
                                  type="date"
                                  value={newPayment.paymentDate}
                                  onChange={(e) =>
                                    handlePaymentInputChange("paymentDate", e.target.value)
                                  }
                                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                                />
                              </div>
                              <div>
                                <label className="text-sm text-gray-500 font-medium">
                                  Payment Mode
                                </label>
                                <select
                                  value={newPayment.modeOfPayment}
                                  onChange={(e) =>
                                    handlePaymentInputChange("modeOfPayment", e.target.value)
                                  }
                                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1">
                                  <option value="">Select Mode</option>
                                  <option value="Cash">Cash</option>
                                  <option value="Phone Pe">Phone Pe</option>
                                  <option value="Google Pay">Google Pay</option>
                                  <option value="Cheque">Cheque</option>
                                  <option value="JPCB">JPCB</option>
                                </select>
                              </div>
                              <div>
                                <label className="text-sm text-gray-500 font-medium">
                                  Payment Status
                                </label>
                                {hasPaymentAddAccess && !isOfficeAdmin ? (
                                  <select
                                    value={newPayment.paymentStatus || "COLLECTED"}
                                    onChange={(e) =>
                                      handlePaymentInputChange("paymentStatus", e.target.value)
                                    }
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1">
                                    <option value="PENDING">PENDING</option>
                                    <option value="COLLECTED">COLLECTED</option>
                                    <option value="REJECTED">REJECTED</option>
                                  </select>
                                ) : (
                                  <div className="w-full px-3 py-2 bg-gray-100 border rounded-lg mt-1 text-sm text-gray-600">
                                    {isOfficeAdmin
                                      ? "PENDING (Contact Accountant to change)"
                                      : "Status cannot be changed"}
                                  </div>
                                )}
                              </div>
                              <div>
                                <label className="text-sm text-gray-500 font-medium">
                                  Bank Name
                                </label>
                                <input
                                  type="text"
                                  value={newPayment.bankName}
                                  onChange={(e) =>
                                    handlePaymentInputChange("bankName", e.target.value)
                                  }
                                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                                  placeholder={
                                    newPayment.modeOfPayment === "Cheque"
                                      ? "Enter bank name"
                                      : "N/A"
                                  }
                                  disabled={newPayment.modeOfPayment !== "Cheque"}
                                />
                              </div>
                            </div>
                            <div className="mt-4">
                              <label className="text-sm text-gray-500 font-medium">Remark</label>
                              <input
                                type="text"
                                value={newPayment.remark}
                                onChange={(e) => handlePaymentInputChange("remark", e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                                placeholder="Optional remark"
                              />
                            </div>

                            {/* Wallet Payment Option for Dealers */}
                            {isDealer && (
                              <div className="mt-4">
                                <div className="flex items-center justify-between bg-gray-50 p-4 rounded-xl">
                                  <div className="flex items-center">
                                    <input
                                      type="checkbox"
                                      id="walletPayment"
                                      checked={newPayment.isWalletPayment}
                                      onChange={(e) =>
                                        handlePaymentInputChange(
                                          "isWalletPayment",
                                          e.target.checked
                                        )
                                      }
                                      className="mr-3 w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500"
                                    />
                                    <label
                                      htmlFor="walletPayment"
                                      className="text-gray-700 font-medium">
                                      Pay from Wallet
                                    </label>
                                  </div>
                                  <div>
                                    <div className="text-xs text-gray-500">Wallet Balance</div>
                                    <div
                                      className={`text-base font-bold ${
                                        newPayment.isWalletPayment &&
                                        Number(newPayment.paidAmount) >
                                          (walletData?.financial?.availableAmount ?? 0)
                                          ? "text-red-600"
                                          : "text-gray-800"
                                      }`}>
                                      ₹
                                      {(
                                        walletData?.financial?.availableAmount ?? 0
                                      )?.toLocaleString()}
                                    </div>
                                  </div>
                                </div>

                                {/* Warning messages for wallet payment */}
                                {newPayment.isWalletPayment && (
                                  <div className="mt-2">
                                    {Number(newPayment.paidAmount) >
                                      (walletData?.financial?.availableAmount ?? 0) && (
                                      <div className="bg-red-50 p-3 rounded-lg">
                                        <div className="text-sm text-red-600 font-medium">
                                          Insufficient wallet balance! Available: ₹
                                          {(
                                            walletData?.financial?.availableAmount ?? 0
                                          )?.toLocaleString()}
                                        </div>
                                      </div>
                                    )}

                                    {!newPayment.paidAmount && (
                                      <div className="bg-amber-50 p-3 rounded-lg">
                                        <div className="text-sm text-amber-600 font-medium">
                                          Please enter payment amount
                                        </div>
                                      </div>
                                    )}

                                    {Number(newPayment.paidAmount) <=
                                      (walletData?.financial?.availableAmount ?? 0) &&
                                      newPayment.paidAmount && (
                                        <div className="bg-green-50 p-3 rounded-lg">
                                          <div className="text-sm text-green-600 font-medium">
                                            Sufficient balance available
                                          </div>
                                        </div>
                                      )}
                                  </div>
                                )}
                              </div>
                            )}

                            {/* Dealer Wallet Payment Option for Accountants (when sales person is dealer) */}
                            {!isDealer &&
                              selectedOrder?.details?.salesPerson?.jobTitle === "DEALER" && (
                                <div className="mt-4">
                                  <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                    <div className="flex items-center justify-between mb-3">
                                      <div className="flex items-center">
                                        <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                          <FaCreditCard className="text-blue-600 text-sm" />
                                        </div>
                                        <div>
                                          <div className="text-sm font-medium text-blue-900">
                                            Dealer Wallet Payment
                                          </div>
                                          <div className="text-xs text-blue-600">
                                            Sales Person:{" "}
                                            {selectedOrder?.details?.salesPerson?.name}
                                          </div>
                                        </div>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-xs text-blue-600">
                                          Available Balance
                                        </div>
                                        <div className="text-lg font-bold text-blue-900">
                                          ₹
                                          {(
                                            dealerWalletData?.financial?.availableAmount ?? 0
                                          )?.toLocaleString()}
                                        </div>
                                      </div>
                                    </div>

                                    <div className="flex items-center">
                                      <input
                                        type="checkbox"
                                        id="dealerWalletPayment"
                                        checked={newPayment.isWalletPayment}
                                        onChange={(e) =>
                                          handlePaymentInputChange(
                                            "isWalletPayment",
                                            e.target.checked
                                          )
                                        }
                                        className="mr-3 w-4 h-4 text-blue-600 bg-blue-100 border-blue-300 rounded focus:ring-blue-500"
                                      />
                                      <label
                                        htmlFor="dealerWalletPayment"
                                        className="text-blue-800 font-medium">
                                        Pay from Dealer&apos;s Wallet
                                      </label>
                                    </div>

                                    {/* Warning messages for dealer wallet payment */}
                                    {newPayment.isWalletPayment && (
                                      <div className="mt-3 space-y-2">
                                        {Number(newPayment.paidAmount) >
                                          (dealerWalletData?.financial?.availableAmount ?? 0) && (
                                          <div className="bg-red-50 p-3 rounded-lg border border-red-200">
                                            <div className="text-sm text-red-600 font-medium">
                                              ⚠️ Insufficient dealer wallet balance! Available: ₹
                                              {(
                                                dealerWalletData?.financial?.availableAmount ?? 0
                                              )?.toLocaleString()}
                                            </div>
                                          </div>
                                        )}

                                        {!newPayment.paidAmount && (
                                          <div className="bg-amber-50 p-3 rounded-lg border border-amber-200">
                                            <div className="text-sm text-amber-600 font-medium">
                                              ℹ️ Please enter payment amount
                                            </div>
                                          </div>
                                        )}

                                        {Number(newPayment.paidAmount) <=
                                          (dealerWalletData?.financial?.availableAmount ?? 0) &&
                                          newPayment.paidAmount && (
                                            <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                              <div className="text-sm text-green-600 font-medium">
                                                ✅ Sufficient dealer balance available
                                              </div>
                                            </div>
                                          )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}
                            <div className="flex items-center justify-end space-x-2 mt-4">
                              <button
                                onClick={() => setShowPaymentForm(false)}
                                className="px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-50">
                                Cancel
                              </button>
                              {hasPaymentAddAccess && (
                                <button
                                  onClick={() =>
                                    handleAddPaymentWithConfirm(selectedOrder.details.orderid)
                                  }
                                  disabled={
                                    !newPayment.paidAmount ||
                                    !newPayment.modeOfPayment ||
                                    (isDealer &&
                                      newPayment.isWalletPayment &&
                                      (Number(newPayment.paidAmount) >
                                        (walletData?.financial?.availableAmount ?? 0) ||
                                        !newPayment.paidAmount)) ||
                                    (!isDealer &&
                                      selectedOrder?.details?.salesPerson?.jobTitle === "DEALER" &&
                                      newPayment.isWalletPayment &&
                                      (Number(newPayment.paidAmount) >
                                        (dealerWalletData?.financial?.availableAmount ?? 0) ||
                                        !newPayment.paidAmount))
                                  }
                                  className={`px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed ${
                                    (isDealer &&
                                      newPayment.isWalletPayment &&
                                      (Number(newPayment.paidAmount) >
                                        (walletData?.financial?.availableAmount ?? 0) ||
                                        !newPayment.paidAmount)) ||
                                    (!isDealer &&
                                      selectedOrder?.details?.salesPerson?.jobTitle === "DEALER" &&
                                      newPayment.isWalletPayment &&
                                      (Number(newPayment.paidAmount) >
                                        (dealerWalletData?.financial?.availableAmount ?? 0) ||
                                        !newPayment.paidAmount))
                                      ? "bg-gray-300 text-gray-500"
                                      : "bg-green-500 text-white hover:bg-green-600"
                                  }`}>
                                  Add Payment
                                  {isOfficeAdmin && (
                                    <span className="ml-1 text-xs">(PENDING only)</span>
                                  )}
                                </button>
                              )}
                            </div>
                          </div>
                        )}

                        {selectedOrder?.details?.payment &&
                          selectedOrder?.details?.payment.length > 0 && (
                            <div className="bg-white rounded-lg border">
                              <div className="p-4 border-b">
                                <h4 className="font-medium text-gray-900">Payment History</h4>
                              </div>
                              <div className="divide-y">
                                {selectedOrder.details.payment.map((payment, pIndex) => (
                                  <div key={pIndex} className="p-4 hover:bg-gray-50">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center space-x-4">
                                        <div className="text-lg font-semibold text-gray-900">
                                          ₹{payment.paidAmount}
                                        </div>
                                        <div className="text-sm text-gray-500">
                                          {payment.modeOfPayment}
                                        </div>
                                        <span
                                          className={`px-2 py-1 text-xs rounded-full ${
                                            payment.paymentStatus === "COLLECTED"
                                              ? "bg-green-100 text-green-700"
                                              : "bg-amber-100 text-amber-700"
                                          }`}>
                                          {payment.paymentStatus}
                                        </span>
                                        {payment.isWalletPayment && (
                                          <span className="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">
                                            Wallet
                                          </span>
                                        )}
                                      </div>
                                      <div className="text-sm text-gray-500">
                                        {moment(payment.paymentDate).format("DD/MM/YYYY")}
                                      </div>
                                    </div>
                                    {payment.remark && (
                                      <div className="mt-2 text-sm text-gray-600">
                                        Remark: {payment.remark}
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                      </div>
                    )}

                    {activeTab === "edit" && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-medium text-gray-900">Edit Order Details</h3>
                        <div className="bg-gray-50 rounded-lg p-6">
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                              <label className="text-sm text-gray-500 font-medium">Rate (₹)</label>
                              <input
                                type="number"
                                value={updatedObject?.rate || selectedOrder?.rate}
                                onChange={(e) => handleInputChange(0, "rate", e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                              />
                            </div>
                            <div>
                              <label className="text-sm text-gray-500 font-medium">Quantity</label>
                              <input
                                type="number"
                                value={updatedObject?.quantity || selectedOrder?.quantity}
                                onChange={(e) => handleInputChange(0, "quantity", e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 mt-1"
                              />
                            </div>
                            <div>
                              <label className="text-sm text-gray-500 font-medium">
                                Delivery Slot
                              </label>
                              <Select
                                value={
                                  updatedObject?.bookingSlot ||
                                  selectedOrder?.details?.bookingSlot?.slotId
                                }
                                onChange={(e) =>
                                  setUpdatedObject({
                                    ...updatedObject,
                                    bookingSlot: e.target.value
                                  })
                                }
                                className="w-full mt-1">
                                <MenuItem value="">Select Slot</MenuItem>
                                {slots.map(({ label, value }) => (
                                  <MenuItem key={value} value={value}>
                                    {label}
                                  </MenuItem>
                                ))}
                              </Select>
                            </div>
                          </div>
                          <div className="flex items-center justify-end space-x-2 mt-6">
                            <button
                              onClick={() => {
                                setUpdatedObject(null)
                                setSelectedRow(null)
                              }}
                              className="px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-50">
                              Cancel
                            </button>
                            <button
                              onClick={() => {
                                pacthOrders(
                                  {
                                    id: selectedOrder?.details?.orderid,
                                    ...updatedObject
                                  },
                                  selectedOrder
                                ).then(() => {
                                  // Refresh modal data after successful edit
                                  setTimeout(() => {
                                    refreshModalData()
                                  }, 1000) // Small delay to ensure API call completes
                                })
                              }}
                              className="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600">
                              Save Changes
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {activeTab === "remarks" && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-medium text-gray-900">Order Remarks</h3>

                        {selectedOrder?.details?.orderRemarks &&
                          selectedOrder?.details?.orderRemarks.length > 0 && (
                            <div className="bg-gray-50 rounded-lg p-4">
                              <h4 className="font-medium text-gray-900 mb-3">Existing Remarks</h4>
                              <div className="space-y-2">
                                {selectedOrder.details.orderRemarks.map((remark, remarkIndex) => (
                                  <div key={remarkIndex} className="bg-white p-3 rounded border">
                                    <div className="text-sm text-gray-700">{remark}</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                        <div className="bg-white rounded-lg border p-4">
                          <h4 className="font-medium text-gray-900 mb-3">Add New Remark</h4>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              placeholder="Enter a new remark..."
                              value={newRemark}
                              onChange={(e) => setNewRemark(e.target.value)}
                              className="flex-grow px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                              onClick={() => handleAddRemark(selectedOrder.details.orderid)}
                              disabled={!newRemark.trim()}
                              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
                              Add Remark
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
      <ConfirmDialog
        open={confirmDialog.open}
        title={confirmDialog.title}
        description={confirmDialog.description}
        onConfirm={confirmDialog.onConfirm}
        onCancel={() => setConfirmDialog((d) => ({ ...d, open: false }))}
      />
    </div>
  )
}

export default FarmerOrdersTable
